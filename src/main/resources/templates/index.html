<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Companion Baccarat App Game Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<style>
    /* Hide scrollbars but still allow scrolling */
    .hidden-scrollbar {
        scrollbar-width: none;
        /* For Firefox */
        -ms-overflow-style: none;
        /* For Internet Explorer and Edge */
    }

    .hidden-scrollbar::-webkit-scrollbar {
        display: none;
        /* For Chrome, Safari, and Opera */
    }

    .glow {
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        /* Gold glow */
        transition: box-shadow 0.3s ease-in-out;
    }

    /* The overlay that covers the whole screen */
    .overlay {
        display: none;
        /* Hidden by default */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.158);
        /* Semi-transparent background */
        justify-content: center;
        align-items: center;
        z-index: 10 00;
    }

    /* The smaller spinner */
    .spinner {
        width: 30px;
        height: 30px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 2s linear infinite;
    }

    /* Spinner animation */
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<body class="bg-gray-100">
    <div class="container mx-auto p-2 relative">
        <!-- Logout Icon - Improved -->
        <div class="absolute top-4 right-4 z-10">
            <form th:action="@{/logout}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit"
                    class="bg-gray-600 text-white text-xs font-semibold py-0.5 px-1 rounded hover:bg-gray-700 transition duration-200 shadow-md"
                    style="background-color: rgb(75 85 99 / 42%);"> <!-- Less transparent -->
                    <i class="fas fa-sign-out-alt text-base"></i>
                </button>
            </form>
        </div>



        <div class="flex flex-col md:flex-row">
            <div class="w-full md:w-2/5 bg-white shadow-md rounded-lg p-4 mb-4" style="margin: 0.25%;">
                <div id="inputsContainer">
                    <form id="gameForm">
                        <div style="height: 150px;">
                            <div id="circleContainer" class="gap-2 mb-2 w-full overflow-x-auto hidden-scrollbar"
                                style="max-height: 150px; white-space: nowrap;">
                                <div id="handResultColumn" class="flex flex-row h-full w-full"></div>
                            </div>
                        </div>

                        <div class="flex justify-between">
                            <button type="button" id="playerButton"
                                class="w-full bg-blue-500 text-white py-1 rounded hover:bg-blue-600 transition duration-200 mr-1">
                                PLAYER
                            </button>
                            <button type="button" id="bankerButton"
                                class="w-full bg-red-500 text-white py-1 rounded hover:bg-red-600 transition duration-200 ml-1">
                                BANKER
                            </button>
                        </div>
                    </form>
                </div>

                <div id="results" class="bg-white p-2 mt-4 rounded-md shadow-sm">
                    <div id="status" class="text-gray-800 font-semibold text-md mb-2 text-center border-b pb-1"></div>
                    <div id="bettingResults" class="text-gray-700"></div>
                    <div id="finalStats" class="mt-2 font-bold text-gray-900"></div>
                </div>

                <div class="flex justify-between">
                    <button type="button" id="resetButton" style="display: none;"
                        class="w-full bg-yellow-500 text-white py-1 rounded hover:bg-yellow-600 transition duration-200 mr-1">
                        Reset Game
                    </button>
                    <button type="button" id="undoButton" style="display: none;"
                        class="w-full bg-green-500 text-white py-1 rounded hover:bg-green-600 transition duration-200 ml-1">
                        Undo
                    </button>
                </div>

                <div class="mt-4" style="display: none;">
                    <div class="bg-blue-100 border border-blue-300 rounded-lg p-2 mb-2">
                        <h3 id="infoHeader" class="font-semibold">Subscription Plan: TRIAL</h3>
                        <p id="infoContent" class="text-gray-700">Days remaining before the subscription ends: 20 <span
                                id="daysRemaining" class="font-bold text-blue-600"></span> days.</p>
                    </div>
                </div>
            </div>

            <!-- Second Panel -->
            <div class="w-full md:w-3/5 bg-white shadow-md rounded-lg p-2 mb-2" style="margin: 0.25%;">
                <h2 class="text-lg font-semibold mb-1">Game Results Overview</h2>
                <p class="text-gray-700 text-sm">Each result below represents the profit details for each shoe.</p>

                <!-- Main Card -->
                <div class="bg-gray-100 border border-gray-300 rounded-lg p-1 mb-1">
                    <h3 class="font-semibold text-sm">Total Profit(u): <span id="totalProfit"></span></h3>
                    <p class="text-gray-700 text-xs">Date/Time: <span id="dateTime"></span></p>
                </div>

                <!-- Sub Card Container -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-1" id="journalContainer">
                    <!-- Journal entries will be populated here -->
                </div>
            </div>

        </div>
    </div>




    <div class="overlay" id="spinnerOverlay">
        <div class="spinner"></div>
    </div>

    <script>

        function showSpinner() {
            // Show the overlay and spinner
            // document.getElementById("spinnerOverlay").style.display = "flex";
            const circleContainer = document.getElementById("circleContainer");
            const spinnerOverlay = document.getElementById("spinnerOverlay");

            // Get the position and dimensions of circleContainer
            const rect = circleContainer.getBoundingClientRect();

            // Position the spinnerOverlay over circleContainer
            spinnerOverlay.style.display = "flex";
            spinnerOverlay.style.position = "absolute";
            spinnerOverlay.style.top = `${rect.top}px`;
            spinnerOverlay.style.left = `${rect.left}px`;
            spinnerOverlay.style.width = `${rect.width}px`;
            spinnerOverlay.style.height = `${rect.height}px`;
        }

        function hideSpinner() {
            // Hide the overlay and spinner
            document.getElementById("spinnerOverlay").style.display = "none";
        }


        $(document).ready(function () {
            (async () => {
                await getJournal();
                await currentState();
            })();

            async function playGame(userInput) {
                const recommendedBetUnit = $('#recommendedBet').text();
                const suggestedBetUnitValue = $('#suggestedBetUnit').text();

                try {
                    const response = await $.ajax({
                        url: '/api/baccarat/play',
                        method: 'POST',
                        contentType: 'application/x-www-form-urlencoded',
                        data: $.param({
                            userInput: userInput,
                            recommendedBet: recommendedBetUnit,
                            suggestedUnit: suggestedBetUnitValue
                        })
                    });
                    displayResultToUi(response);
                } catch (xhr) {

                    $('#playerButton').prop('disabled', false);
                    $('#bankerButton').prop('disabled', false);

                    $('#status').text(`Error: ${xhr.responseText}`);
                }
            }

            // Event listener for PLAYER button
            $('#playerButton').on('click', function () {
                $('#playerButton').prop('disabled', true);
                showSpinner();
                playGame('p');
            });

            // Event listener for BANKER button
            $('#bankerButton').on('click', function () {
                $('#bankerButton').prop('disabled', true);
                showSpinner();
                playGame('b');
            });

            // Event listener for UNDO button
            $('#undoButton').on('click', async function () {
                $('#undoButton').prop('disabled', true);
                showSpinner();
                await undo();
            });

            // Event listener for RESET GAME button
            $('#resetButton').on('click', async function () {
                $('#resetButton').prop('disabled', true);
                showSpinner();
                try {
                    const response = await $.ajax({
                        url: '/api/baccarat/reset',
                        method: 'POST'
                    });
                    displayResultToUi(response);
                } catch (xhr) {
                    $('#resetButton').prop('disabled', false);

                    $('#status').text(`Error: ${xhr.responseText}`);
                }
            });
        });

        async function displayResultToUi(response) {
            // console.log(response);
            hideSpinner();
            $('#playerButton').prop('disabled', false);
            $('#bankerButton').prop('disabled', false);
            $('#resetButton').prop('disabled', false);
            $('#undoButton').prop('disabled', false);

            if (response.gameStatus.handCount > 0) {
                $('#resetButton').show();
                $('#undoButton').show();
                if (response.gameStatus.handCount === 1) {
                    $('#undoButton').hide();
                }
            } else {
                $('#resetButton').hide();
                $('#undoButton').hide();
            }

            // Set the text and change color based on the message
            const statusMessage = response.message;
            $('#status').text(statusMessage).css('color', statusMessage.includes("profit") ? 'green' : statusMessage.includes("loss") ? 'red' : 'black');

            if (statusMessage.includes("reset") || statusMessage.includes("Initialized")) {
                $("#handResultColumn").html("");
                $('#status').text("");
                await getJournal();
            }

            $("#baseBetUnit").val(response.baseBetUnit);
            $("#initialPlayingUnit").val(response.initialPlayingUnits);


            $('#bettingResults').html(`
    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <div class="bg-gray-200 text-gray-800 text-xs font-semibold p-1">
            Betting Results
        </div>
        <div class="p-2">
            <div class="space-y-1">
                <div class="flex justify-between">
                    <span class="font-bold text-xs">Hands:</span>
                    <span class="text-xs">${response.gameStatus.handCount}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-bold text-xs">Wins:</span>
                    <span class="text-xs">${response.gameStatus.wins}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-bold text-xs">Losses:</span>
                    <span class="text-xs">${response.gameStatus.losses}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-bold text-xs">Units:</span>
                    <span class="text-xs">${response.gameStatus.playingUnits.toFixed(0)}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-bold text-xs">Net Profit:</span>
                    <span class="text-xs ${response.gameStatus.profit >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${response.gameStatus.profit.toFixed(0)}
                    </span>
                </div>
                <div class="flex justify-between">
                    <span class="font-bold text-xs">Suggested Unit:</span>
                    <span class="text-xs">${response.suggestedBetUnit.toFixed(0)}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-bold text-xs">Next Bet:</span>
                    <span class="text-xs">${response.recommendedBet}</span>
                </div>
            </div>
        </div>
    </div>
    <p id="recommendedBet" style="display:none;">${response.recommendedBet}</p>
    <p id="suggestedBetUnit" style="display:none;">${response.suggestedBetUnit.toFixed(0)}</p>
`);





            displayResults(response.sequence.toUpperCase());

            // Show or hide the RESET GAME button based on the result
            if (statusMessage.includes("reached")) {
                $('#playerButton, #bankerButton').prop('disabled', true);
                $('#undoButton').hide();
                $('#resetButton').show();
                await getJournal();
            } else {
                $('#playerButton, #bankerButton').prop('disabled', false);
            }

            if (response.dailyLimitReached) {
                $('#resetButton').hide();
            }
        }

        async function undo() {
            try {


                const response = await $.ajax({
                    url: '/api/baccarat/undo',
                    method: 'POST',
                    contentType: 'application/x-www-form-urlencoded'
                });
                displayResultToUi(response);
            } catch (xhr) {
                $('#undoButton').prop('disabled', false);
                $('#responseMessage').text("An error occurred: " + xhr.responseText);
                console.error("Error details:", xhr);
            }
        }

        function addContainer(group) {
            const container = document.createElement('div');
            container.classList.add('flex', 'flex-col', 'items-start', 'justify-start', 'h-full');

            // Create circles for each character in the group         
            let circleNumber = 1;
            for (const char of group) {
                const circle = document.createElement('div');
                circle.classList.add('flex', 'items-center', 'justify-center', 'w-6', 'h-6', 'border', 'border-gray-300', 'rounded-full', char === 'P' ? 'bg-blue-500' : 'bg-red-500', 'mb-1');

                // Create a smaller white circle inside
                const innerCircle = document.createElement('div');
                innerCircle.classList.add('flex', 'items-center', 'justify-center', 'w-3', 'h-3', 'bg-white', 'rounded-full', 'text-xs', 'text-gray-400');
                innerCircle.textContent = circleNumber;

                // Add the inner circle to the outer circle
                circle.appendChild(innerCircle);
                // Add the outer circle to the container
                container.appendChild(circle);
                circleNumber++;
            }

            return container; // Return the container with circles
        }

        function displayResults(playerAndBankerCollections) {

            const results = playerAndBankerCollections.replace("1111", "").split('');
            if (results.length === 0) {
                return;
            }

            // Clear previous results
            document.getElementById('handResultColumn').innerHTML = '';

            let currentChar = results[0];
            let group = currentChar; // Initialize the group with the first character
            const column = document.getElementById('handResultColumn');
            const circleContainer = document.getElementById('circleContainer'); // Reference to the outer container

            for (let i = 1; i < results.length; i++) {
                if (results[i] === currentChar) {
                    group += results[i]; // Add to the current group if same
                } else {
                    // Create and append the container for the current group
                    column.appendChild(addContainer(group));
                    currentChar = results[i]; // Update currentChar
                    group = currentChar; // Start a new group
                }
            }

            // Append the last group after the loop
            column.appendChild(addContainer(group));

            // Auto-scroll the circleContainer to the right after adding new content
            setTimeout(() => {
                circleContainer.scrollLeft = circleContainer.scrollWidth;
            }, 0); // Using a timeout to ensure rendering is complete before scrolling
        }

        async function getJournal() {
            const currentDate = new Date();
            const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const options = { timeZone: userTimeZone, year: 'numeric', month: '2-digit', day: '2-digit' };
            const localDate = currentDate.toLocaleDateString('en-CA', options);  // Format: YYYY-MM-DD

            try {
                const response = await $.ajax({
                    url: '/api/journals/dateCreated',
                    type: 'GET',
                    data: { dateCreated: localDate }
                });

                $('#journalContainer').html('');
                $('#dateTime').text(localDate);
                const journalContainer = document.getElementById('journalContainer');
                let totalProfit = 0;
                let lastValidIndex = -1;

                response.forEach((journal, index) => {
                    if (journal.hand !== 0) {
                        lastValidIndex = index; // Update lastValidIndex if Hand is not 0
                    }
                });

                response.forEach((journal, index) => {
                    const journalDiv = document.createElement('div');
                    journalDiv.classList.add('bg-white', 'border', 'border-gray-300', 'rounded-lg', 'p-2', 'mb-2'); // Reduced padding and margin

                    const shoeHeading = document.createElement('h4');
                    shoeHeading.classList.add('font-semibold', 'text-sm'); // Reduced font size
                    shoeHeading.textContent = `Shoe: ${journal.shoe}`;

                    const handParagraph = document.createElement('p');
                    handParagraph.classList.add('text-gray-700', 'text-xs'); // Reduced font size
                    handParagraph.textContent = `Hand: ${journal.hand}`;

                    const profitParagraph = document.createElement('p');
                    profitParagraph.classList.add('text-gray-700', 'text-xs'); // Reduced font size
                    profitParagraph.textContent = `Profit: ${journal.profit}`;

                    totalProfit += journal.profit;

                    journalDiv.appendChild(shoeHeading);
                    journalDiv.appendChild(handParagraph);
                    journalDiv.appendChild(profitParagraph);

                    journalContainer.appendChild(journalDiv);

                    // Add a glowing effect to the last card with Hand not equal to 0
                    if (index === lastValidIndex) {
                        journalDiv.classList.add('glow'); // Add a class for glowing effect
                    }
                });

                $('#totalProfit').text(totalProfit);
            } catch (xhr) {
                console.error('Error fetching journals:', xhr);
                alert('An error occurred while fetching journals. Please try again.');
            }
        }

        async function currentState() {
            const statusMessage = $('#status').text();

            try {
                const response = await $.ajax({
                    url: '/api/baccarat/current-state',
                    type: 'GET',
                    data: { message: statusMessage }
                });
                displayResultToUi(response);
            } catch (xhr) {
                console.error('Error fetching current state:', xhr);
                $('#status').text(`Error: ${xhr.responseText}`);
            }
        }
    </script>

</body>

</html>